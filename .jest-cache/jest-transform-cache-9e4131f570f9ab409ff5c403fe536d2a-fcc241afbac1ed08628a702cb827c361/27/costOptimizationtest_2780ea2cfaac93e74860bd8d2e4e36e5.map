{"version":3,"names":["responseCache","compressPrompt","deduplicateMessages","estimateTokens","describe","beforeEach","clear","test","messages","role","content","hash1","generateHash","hash2","expect","toBe","toHaveLength","messages1","messages2","not","hash","toBeDefined","result","get","toBeNull","response","set","shortTTLCache","constructor","Promise","resolve","setTimeout","smallCache","messages3","prompt","toEqual"],"sources":["costOptimization.test.js"],"sourcesContent":["/**\n * COST OPTIMIZATION SYSTEM TESTS\n * Testes unitários para o sistema de otimização de custo\n */\n\nimport {\n  responseCache,\n  compressPrompt,\n  deduplicateMessages,\n  estimateTokens,\n} from '../costOptimization.js';\n\ndescribe('Cost Optimization System', () => {\n  describe('ResponseCache', () => {\n    beforeEach(() => {\n      responseCache.clear();\n    });\n\n    describe('generateHash', () => {\n      test('deve gerar hash MD5 consistente para mesmas mensagens', () => {\n        const messages = [\n          { role: 'user', content: 'Hello' },\n          { role: 'assistant', content: 'Hi there!' },\n        ];\n\n        const hash1 = responseCache.generateHash(messages);\n        const hash2 = responseCache.generateHash(messages);\n\n        expect(hash1).toBe(hash2);\n        expect(hash1).toHaveLength(32); // MD5 hash length\n      });\n\n      test('deve gerar hashes diferentes para mensagens diferentes', () => {\n        const messages1 = [{ role: 'user', content: 'Hello' }];\n        const messages2 = [{ role: 'user', content: 'Goodbye' }];\n\n        const hash1 = responseCache.generateHash(messages1);\n        const hash2 = responseCache.generateHash(messages2);\n\n        expect(hash1).not.toBe(hash2);\n      });\n\n      test('deve funcionar com arrays de objetos', () => {\n        const messages = [\n          { role: 'user', content: 'Question 1' },\n          { role: 'assistant', content: 'Answer 1' },\n          { role: 'user', content: 'Question 2' },\n        ];\n\n        const hash = responseCache.generateHash(messages);\n\n        expect(hash).toBeDefined();\n        expect(typeof hash).toBe('string');\n        expect(hash).toHaveLength(32);\n      });\n    });\n\n    describe('get', () => {\n      test('deve retornar null para cache miss', () => {\n        const messages = [{ role: 'user', content: 'New message' }];\n        const result = responseCache.get(messages);\n\n        expect(result).toBeNull();\n      });\n\n      test('deve retornar resposta cacheada para cache hit', () => {\n        const messages = [{ role: 'user', content: 'Test message' }];\n        const response = 'Cached response';\n\n        // Salvar no cache\n        responseCache.set(messages, response);\n\n        // Buscar do cache\n        const result = responseCache.get(messages);\n\n        expect(result).toBe(response);\n      });\n\n      test('deve retornar null para cache expirado (TTL)', () => {\n        // Criar cache com TTL muito curto (1ms)\n        const shortTTLCache = new (responseCache.constructor)(1000, 1);\n        const messages = [{ role: 'user', content: 'Expiring message' }];\n        const response = 'Will expire';\n\n        // Salvar no cache\n        shortTTLCache.set(messages, response);\n\n        // Aguardar expiração\n        return new Promise((resolve) => {\n          setTimeout(() => {\n            const result = shortTTLCache.get(messages);\n            expect(result).toBeNull();\n            resolve();\n          }, 10);\n        });\n      });\n    });\n\n    describe('set', () => {\n      test('deve salvar resposta no cache', () => {\n        const messages = [{ role: 'user', content: 'Save this' }];\n        const response = 'Saved response';\n\n        responseCache.set(messages, response);\n        const result = responseCache.get(messages);\n\n        expect(result).toBe(response);\n      });\n\n      test('deve limpar cache mais antigo quando atingir maxSize', () => {\n        // Criar cache com tamanho máximo de 2\n        const smallCache = new (responseCache.constructor)(2, 3600000);\n\n        const messages1 = [{ role: 'user', content: 'Message 1' }];\n        const messages2 = [{ role: 'user', content: 'Message 2' }];\n        const messages3 = [{ role: 'user', content: 'Message 3' }];\n\n        // Adicionar 3 itens (deve remover o primeiro)\n        smallCache.set(messages1, 'Response 1');\n        smallCache.set(messages2, 'Response 2');\n        smallCache.set(messages3, 'Response 3');\n\n        // O primeiro deve ter sido removido\n        expect(smallCache.get(messages1)).toBeNull();\n        // Os outros dois devem existir\n        expect(smallCache.get(messages2)).toBe('Response 2');\n        expect(smallCache.get(messages3)).toBe('Response 3');\n      });\n    });\n  });\n\n  describe('compressPrompt', () => {\n    test('deve remover múltiplos espaços', () => {\n      const prompt = 'This   has    multiple     spaces';\n      const result = compressPrompt(prompt);\n\n      expect(result).toBe('This has multiple spaces');\n    });\n\n    test('deve remover quebras de linha desnecessárias', () => {\n      const prompt = 'Line 1\\n\\n\\n\\nLine 2';\n      const result = compressPrompt(prompt);\n\n      expect(result).toBe('Line 1\\n\\nLine 2');\n    });\n\n    test('deve fazer trim do texto', () => {\n      const prompt = '   Text with spaces   ';\n      const result = compressPrompt(prompt);\n\n      expect(result).toBe('Text with spaces');\n    });\n\n    test('deve aplicar todas as otimizações juntas', () => {\n      const prompt = '  This   has   \\n\\n\\n  multiple    issues  \\n\\n\\n  ';\n      const result = compressPrompt(prompt);\n\n      expect(result).toBe('This has\\n\\nmultiple issues');\n    });\n\n    test('deve manter texto já otimizado inalterado', () => {\n      const prompt = 'Already optimized text';\n      const result = compressPrompt(prompt);\n\n      expect(result).toBe('Already optimized text');\n    });\n  });\n\n  describe('deduplicateMessages', () => {\n    test('deve remover mensagens duplicadas consecutivas', () => {\n      const messages = [\n        { role: 'user', content: 'Hello' },\n        { role: 'user', content: 'Hello' },\n        { role: 'assistant', content: 'Hi' },\n      ];\n\n      const result = deduplicateMessages(messages);\n\n      expect(result).toHaveLength(2);\n      expect(result[0].content).toBe('Hello');\n      expect(result[1].content).toBe('Hi');\n    });\n\n    test('deve manter mensagens não-consecutivas duplicadas', () => {\n      const messages = [\n        { role: 'user', content: 'Hello' },\n        { role: 'assistant', content: 'Hi' },\n        { role: 'user', content: 'Hello' },\n      ];\n\n      const result = deduplicateMessages(messages);\n\n      expect(result).toHaveLength(3);\n      expect(result[0].content).toBe('Hello');\n      expect(result[1].content).toBe('Hi');\n      expect(result[2].content).toBe('Hello');\n    });\n\n    test('deve retornar array vazio para input vazio', () => {\n      const messages = [];\n      const result = deduplicateMessages(messages);\n\n      expect(result).toEqual([]);\n      expect(result).toHaveLength(0);\n    });\n\n    test('deve manter mensagens únicas inalteradas', () => {\n      const messages = [\n        { role: 'user', content: 'Message 1' },\n        { role: 'assistant', content: 'Response 1' },\n        { role: 'user', content: 'Message 2' },\n      ];\n\n      const result = deduplicateMessages(messages);\n\n      expect(result).toHaveLength(3);\n      expect(result).toEqual(messages);\n    });\n\n    test('deve lidar com múltiplas duplicatas consecutivas', () => {\n      const messages = [\n        { role: 'user', content: 'Same' },\n        { role: 'user', content: 'Same' },\n        { role: 'user', content: 'Same' },\n        { role: 'assistant', content: 'Different' },\n      ];\n\n      const result = deduplicateMessages(messages);\n\n      expect(result).toHaveLength(2);\n      expect(result[0].content).toBe('Same');\n      expect(result[1].content).toBe('Different');\n    });\n  });\n});\n"],"mappings":"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","ignoreList":[]}