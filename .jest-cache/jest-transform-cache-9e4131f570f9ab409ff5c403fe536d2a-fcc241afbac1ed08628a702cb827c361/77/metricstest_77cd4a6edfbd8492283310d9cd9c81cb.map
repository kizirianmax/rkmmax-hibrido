{"version":3,"names":["_metrics","require","describe","metrics","beforeEach","PerformanceMetrics","test","recordRequest","success","responseTime","engine","cached","stats","getMetrics","expect","requests","total","toBe","successful","failed","error","timeout","performance","timeouts","engines","times","forEach","time","avgResponseTime","minResponseTime","maxResponseTime","cache","hits","misses","hitRate","successRate","recentErrors","toHaveLength","message","i","responseTimes","errors","p95","parseInt","p95ResponseTime","p99","p99ResponseTime","toBeGreaterThanOrEqual","reset","Object","keys","mockSentry","setContext","jest","fn","exportToSentry","toHaveBeenCalledWith","any"],"sources":["metrics.test.js"],"sourcesContent":["/**\n * Tests for Performance Metrics\n */\n\nimport { PerformanceMetrics } from '../lib/metrics.js';\n\ndescribe('PerformanceMetrics', () => {\n  let metrics;\n\n  beforeEach(() => {\n    metrics = new PerformanceMetrics();\n  });\n\n  test('should record successful request', () => {\n    metrics.recordRequest({\n      success: true,\n      responseTime: 1500,\n      engine: 'gemini-pro',\n      cached: false,\n    });\n\n    const stats = metrics.getMetrics();\n    expect(stats.requests.total).toBe(1);\n    expect(stats.requests.successful).toBe(1);\n    expect(stats.requests.failed).toBe(0);\n  });\n\n  test('should record failed request', () => {\n    metrics.recordRequest({\n      success: false,\n      responseTime: 2000,\n      engine: 'groq-speed',\n      error: 'Timeout error',\n      timeout: true,\n    });\n\n    const stats = metrics.getMetrics();\n    expect(stats.requests.total).toBe(1);\n    expect(stats.requests.failed).toBe(1);\n    expect(stats.performance.timeouts).toBe(1);\n  });\n\n  test('should track engine usage', () => {\n    metrics.recordRequest({ success: true, engine: 'gemini-pro' });\n    metrics.recordRequest({ success: true, engine: 'gemini-pro' });\n    metrics.recordRequest({ success: true, engine: 'groq-speed' });\n\n    const stats = metrics.getMetrics();\n    expect(stats.engines['gemini-pro']).toBe(2);\n    expect(stats.engines['groq-speed']).toBe(1);\n  });\n\n  test('should calculate response time statistics', () => {\n    const times = [1000, 1500, 2000, 2500, 3000];\n    \n    times.forEach(time => {\n      metrics.recordRequest({ success: true, responseTime: time });\n    });\n\n    const stats = metrics.getMetrics();\n    expect(stats.performance.avgResponseTime).toBe('2000ms');\n    expect(stats.performance.minResponseTime).toBe('1000ms');\n    expect(stats.performance.maxResponseTime).toBe('3000ms');\n  });\n\n  test('should track cache statistics', () => {\n    metrics.recordRequest({ success: true, cached: true });\n    metrics.recordRequest({ success: true, cached: true });\n    metrics.recordRequest({ success: true, cached: false });\n\n    const stats = metrics.getMetrics();\n    expect(stats.cache.hits).toBe(2);\n    expect(stats.cache.misses).toBe(1);\n    expect(stats.cache.hitRate).toBe('66.67%');\n  });\n\n  test('should calculate success rate correctly', () => {\n    metrics.recordRequest({ success: true });\n    metrics.recordRequest({ success: true });\n    metrics.recordRequest({ success: false });\n    metrics.recordRequest({ success: true });\n\n    const stats = metrics.getMetrics();\n    expect(stats.requests.successRate).toBe('75.00%');\n  });\n\n  test('should track recent errors', () => {\n    metrics.recordRequest({\n      success: false,\n      error: 'First error',\n      engine: 'gemini-pro',\n    });\n\n    metrics.recordRequest({\n      success: false,\n      error: 'Second error',\n      engine: 'groq-speed',\n    });\n\n    const stats = metrics.getMetrics();\n    expect(stats.recentErrors).toHaveLength(2);\n    expect(stats.recentErrors[0].message).toBe('First error');\n    expect(stats.recentErrors[1].message).toBe('Second error');\n  });\n\n  test('should limit response time history to 1000', () => {\n    // Add 1500 entries\n    for (let i = 0; i < 1500; i++) {\n      metrics.recordRequest({ success: true, responseTime: 1000 + i });\n    }\n\n    expect(metrics.metrics.responseTimes).toHaveLength(1000);\n  });\n\n  test('should limit error history to 100', () => {\n    // Add 150 errors\n    for (let i = 0; i < 150; i++) {\n      metrics.recordRequest({\n        success: false,\n        error: `Error ${i}`,\n      });\n    }\n\n    expect(metrics.metrics.errors).toHaveLength(100);\n  });\n\n  test('should calculate P95 and P99 correctly', () => {\n    // Add 100 response times from 0 to 99ms\n    for (let i = 0; i < 100; i++) {\n      metrics.recordRequest({ success: true, responseTime: i });\n    }\n\n    const stats = metrics.getMetrics();\n    const p95 = parseInt(stats.performance.p95ResponseTime);\n    const p99 = parseInt(stats.performance.p99ResponseTime);\n    \n    expect(p95).toBeGreaterThanOrEqual(90);\n    expect(p99).toBeGreaterThanOrEqual(95);\n  });\n\n  test('should handle zero requests gracefully', () => {\n    const stats = metrics.getMetrics();\n    \n    expect(stats.requests.total).toBe(0);\n    expect(stats.requests.successRate).toBe('0%');\n    expect(stats.cache.hitRate).toBe('0%');\n    expect(stats.performance.avgResponseTime).toBe('0ms');\n  });\n\n  test('should reset metrics correctly', () => {\n    metrics.recordRequest({ success: true, responseTime: 1000, engine: 'gemini-pro' });\n    metrics.recordRequest({ success: false, error: 'Test error' });\n\n    metrics.reset();\n\n    const stats = metrics.getMetrics();\n    expect(stats.requests.total).toBe(0);\n    expect(stats.requests.successful).toBe(0);\n    expect(stats.requests.failed).toBe(0);\n    expect(stats.performance.timeouts).toBe(0);\n    expect(Object.keys(stats.engines)).toHaveLength(0);\n  });\n\n  test('should export to Sentry format', () => {\n    const mockSentry = {\n      setContext: jest.fn(),\n    };\n\n    metrics.recordRequest({\n      success: true,\n      responseTime: 1500,\n      engine: 'gemini-pro',\n    });\n\n    metrics.exportToSentry(mockSentry);\n\n    expect(mockSentry.setContext).toHaveBeenCalledWith('performance', expect.any(Object));\n    expect(mockSentry.setContext).toHaveBeenCalledWith('engines', expect.any(Object));\n    expect(mockSentry.setContext).toHaveBeenCalledWith('cache', expect.any(Object));\n  });\n});\n"],"mappings":"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","ignoreList":[]}