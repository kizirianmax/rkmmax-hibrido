{"version":3,"names":["_circuitBreaker","require","describe","breaker","beforeEach","CircuitBreaker","timeout","threshold","resetTimeout","test","mockFn","jest","fn","mockResolvedValue","result","execute","expect","toBe","state","successCount","slowFn","Promise","resolve","setTimeout","rejects","toThrow","failures","failingFn","mockRejectedValue","Error","fallbackFn","toHaveBeenCalled","stats","getStats","toHaveProperty","reset"],"sources":["circuit-breaker.test.js"],"sourcesContent":["/**\n * Tests for Circuit Breaker functionality\n */\n\nimport { CircuitBreaker } from '../lib/circuit-breaker.js';\n\ndescribe('CircuitBreaker', () => {\n  let breaker;\n\n  beforeEach(() => {\n    breaker = new CircuitBreaker('test-breaker', {\n      timeout: 1000,\n      threshold: 2,\n      resetTimeout: 5000,\n    });\n  });\n\n  test('should execute function successfully', async () => {\n    const mockFn = jest.fn().mockResolvedValue('success');\n    const result = await breaker.execute(mockFn);\n    \n    expect(result).toBe('success');\n    expect(breaker.state).toBe('CLOSED');\n    expect(breaker.successCount).toBe(1);\n  });\n\n  test('should timeout if function takes too long', async () => {\n    const slowFn = () => new Promise(resolve => setTimeout(() => resolve('done'), 2000));\n    \n    await expect(breaker.execute(slowFn)).rejects.toThrow('Timeout after 1000ms');\n    expect(breaker.failures).toBe(1);\n  });\n\n  test('should open circuit after threshold failures', async () => {\n    const failingFn = jest.fn().mockRejectedValue(new Error('fail'));\n    \n    // First failure\n    await expect(breaker.execute(failingFn)).rejects.toThrow();\n    expect(breaker.state).toBe('CLOSED');\n    \n    // Second failure - should open circuit\n    await expect(breaker.execute(failingFn)).rejects.toThrow();\n    expect(breaker.state).toBe('OPEN');\n  });\n\n  test('should use fallback when circuit is open', async () => {\n    const failingFn = jest.fn().mockRejectedValue(new Error('fail'));\n    const fallbackFn = jest.fn().mockResolvedValue('fallback-result');\n    \n    // Open the circuit\n    await expect(breaker.execute(failingFn)).rejects.toThrow();\n    await expect(breaker.execute(failingFn)).rejects.toThrow();\n    expect(breaker.state).toBe('OPEN');\n    \n    // Should use fallback\n    const result = await breaker.execute(failingFn, fallbackFn);\n    expect(result).toBe('fallback-result');\n    expect(fallbackFn).toHaveBeenCalled();\n  });\n\n  test('should return correct stats', () => {\n    const stats = breaker.getStats();\n    \n    expect(stats).toHaveProperty('name', 'test-breaker');\n    expect(stats).toHaveProperty('state', 'CLOSED');\n    expect(stats).toHaveProperty('failures', 0);\n    expect(stats).toHaveProperty('successCount', 0);\n    expect(stats).toHaveProperty('totalCalls', 0);\n    expect(stats).toHaveProperty('successRate');\n  });\n\n  test('should reset circuit correctly', async () => {\n    const failingFn = jest.fn().mockRejectedValue(new Error('fail'));\n    \n    // Open the circuit\n    await expect(breaker.execute(failingFn)).rejects.toThrow();\n    await expect(breaker.execute(failingFn)).rejects.toThrow();\n    expect(breaker.state).toBe('OPEN');\n    \n    // Reset\n    breaker.reset();\n    expect(breaker.state).toBe('CLOSED');\n    expect(breaker.failures).toBe(0);\n  });\n});\n"],"mappings":"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","ignoreList":[]}