88bedbefe12593aad149b0a866672c76
"use strict";

var _circuitBreaker = require("../lib/circuit-breaker.js");
/**
 * Tests for Circuit Breaker functionality
 */

describe('CircuitBreaker', () => {
  let breaker;
  beforeEach(() => {
    breaker = new _circuitBreaker.CircuitBreaker('test-breaker', {
      timeout: 1000,
      threshold: 2,
      resetTimeout: 5000
    });
  });
  test('should execute function successfully', async () => {
    const mockFn = jest.fn().mockResolvedValue('success');
    const result = await breaker.execute(mockFn);
    expect(result).toBe('success');
    expect(breaker.state).toBe('CLOSED');
    expect(breaker.successCount).toBe(1);
  });
  test('should timeout if function takes too long', async () => {
    const slowFn = () => new Promise(resolve => setTimeout(() => resolve('done'), 2000));
    await expect(breaker.execute(slowFn)).rejects.toThrow('Timeout after 1000ms');
    expect(breaker.failures).toBe(1);
  });
  test('should open circuit after threshold failures', async () => {
    const failingFn = jest.fn().mockRejectedValue(new Error('fail'));

    // First failure
    await expect(breaker.execute(failingFn)).rejects.toThrow();
    expect(breaker.state).toBe('CLOSED');

    // Second failure - should open circuit
    await expect(breaker.execute(failingFn)).rejects.toThrow();
    expect(breaker.state).toBe('OPEN');
  });
  test('should use fallback when circuit is open', async () => {
    const failingFn = jest.fn().mockRejectedValue(new Error('fail'));
    const fallbackFn = jest.fn().mockResolvedValue('fallback-result');

    // Open the circuit
    await expect(breaker.execute(failingFn)).rejects.toThrow();
    await expect(breaker.execute(failingFn)).rejects.toThrow();
    expect(breaker.state).toBe('OPEN');

    // Should use fallback
    const result = await breaker.execute(failingFn, fallbackFn);
    expect(result).toBe('fallback-result');
    expect(fallbackFn).toHaveBeenCalled();
  });
  test('should return correct stats', () => {
    const stats = breaker.getStats();
    expect(stats).toHaveProperty('name', 'test-breaker');
    expect(stats).toHaveProperty('state', 'CLOSED');
    expect(stats).toHaveProperty('failures', 0);
    expect(stats).toHaveProperty('successCount', 0);
    expect(stats).toHaveProperty('totalCalls', 0);
    expect(stats).toHaveProperty('successRate');
  });
  test('should reset circuit correctly', async () => {
    const failingFn = jest.fn().mockRejectedValue(new Error('fail'));

    // Open the circuit
    await expect(breaker.execute(failingFn)).rejects.toThrow();
    await expect(breaker.execute(failingFn)).rejects.toThrow();
    expect(breaker.state).toBe('OPEN');

    // Reset
    breaker.reset();
    expect(breaker.state).toBe('CLOSED');
    expect(breaker.failures).toBe(0);
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfY2lyY3VpdEJyZWFrZXIiLCJyZXF1aXJlIiwiZGVzY3JpYmUiLCJicmVha2VyIiwiYmVmb3JlRWFjaCIsIkNpcmN1aXRCcmVha2VyIiwidGltZW91dCIsInRocmVzaG9sZCIsInJlc2V0VGltZW91dCIsInRlc3QiLCJtb2NrRm4iLCJqZXN0IiwiZm4iLCJtb2NrUmVzb2x2ZWRWYWx1ZSIsInJlc3VsdCIsImV4ZWN1dGUiLCJleHBlY3QiLCJ0b0JlIiwic3RhdGUiLCJzdWNjZXNzQ291bnQiLCJzbG93Rm4iLCJQcm9taXNlIiwicmVzb2x2ZSIsInNldFRpbWVvdXQiLCJyZWplY3RzIiwidG9UaHJvdyIsImZhaWx1cmVzIiwiZmFpbGluZ0ZuIiwibW9ja1JlamVjdGVkVmFsdWUiLCJFcnJvciIsImZhbGxiYWNrRm4iLCJ0b0hhdmVCZWVuQ2FsbGVkIiwic3RhdHMiLCJnZXRTdGF0cyIsInRvSGF2ZVByb3BlcnR5IiwicmVzZXQiXSwic291cmNlcyI6WyJjaXJjdWl0LWJyZWFrZXIudGVzdC5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIFRlc3RzIGZvciBDaXJjdWl0IEJyZWFrZXIgZnVuY3Rpb25hbGl0eVxuICovXG5cbmltcG9ydCB7IENpcmN1aXRCcmVha2VyIH0gZnJvbSAnLi4vbGliL2NpcmN1aXQtYnJlYWtlci5qcyc7XG5cbmRlc2NyaWJlKCdDaXJjdWl0QnJlYWtlcicsICgpID0+IHtcbiAgbGV0IGJyZWFrZXI7XG5cbiAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgYnJlYWtlciA9IG5ldyBDaXJjdWl0QnJlYWtlcigndGVzdC1icmVha2VyJywge1xuICAgICAgdGltZW91dDogMTAwMCxcbiAgICAgIHRocmVzaG9sZDogMixcbiAgICAgIHJlc2V0VGltZW91dDogNTAwMCxcbiAgICB9KTtcbiAgfSk7XG5cbiAgdGVzdCgnc2hvdWxkIGV4ZWN1dGUgZnVuY3Rpb24gc3VjY2Vzc2Z1bGx5JywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IG1vY2tGbiA9IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSgnc3VjY2VzcycpO1xuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGJyZWFrZXIuZXhlY3V0ZShtb2NrRm4pO1xuICAgIFxuICAgIGV4cGVjdChyZXN1bHQpLnRvQmUoJ3N1Y2Nlc3MnKTtcbiAgICBleHBlY3QoYnJlYWtlci5zdGF0ZSkudG9CZSgnQ0xPU0VEJyk7XG4gICAgZXhwZWN0KGJyZWFrZXIuc3VjY2Vzc0NvdW50KS50b0JlKDEpO1xuICB9KTtcblxuICB0ZXN0KCdzaG91bGQgdGltZW91dCBpZiBmdW5jdGlvbiB0YWtlcyB0b28gbG9uZycsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBzbG93Rm4gPSAoKSA9PiBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHNldFRpbWVvdXQoKCkgPT4gcmVzb2x2ZSgnZG9uZScpLCAyMDAwKSk7XG4gICAgXG4gICAgYXdhaXQgZXhwZWN0KGJyZWFrZXIuZXhlY3V0ZShzbG93Rm4pKS5yZWplY3RzLnRvVGhyb3coJ1RpbWVvdXQgYWZ0ZXIgMTAwMG1zJyk7XG4gICAgZXhwZWN0KGJyZWFrZXIuZmFpbHVyZXMpLnRvQmUoMSk7XG4gIH0pO1xuXG4gIHRlc3QoJ3Nob3VsZCBvcGVuIGNpcmN1aXQgYWZ0ZXIgdGhyZXNob2xkIGZhaWx1cmVzJywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IGZhaWxpbmdGbiA9IGplc3QuZm4oKS5tb2NrUmVqZWN0ZWRWYWx1ZShuZXcgRXJyb3IoJ2ZhaWwnKSk7XG4gICAgXG4gICAgLy8gRmlyc3QgZmFpbHVyZVxuICAgIGF3YWl0IGV4cGVjdChicmVha2VyLmV4ZWN1dGUoZmFpbGluZ0ZuKSkucmVqZWN0cy50b1Rocm93KCk7XG4gICAgZXhwZWN0KGJyZWFrZXIuc3RhdGUpLnRvQmUoJ0NMT1NFRCcpO1xuICAgIFxuICAgIC8vIFNlY29uZCBmYWlsdXJlIC0gc2hvdWxkIG9wZW4gY2lyY3VpdFxuICAgIGF3YWl0IGV4cGVjdChicmVha2VyLmV4ZWN1dGUoZmFpbGluZ0ZuKSkucmVqZWN0cy50b1Rocm93KCk7XG4gICAgZXhwZWN0KGJyZWFrZXIuc3RhdGUpLnRvQmUoJ09QRU4nKTtcbiAgfSk7XG5cbiAgdGVzdCgnc2hvdWxkIHVzZSBmYWxsYmFjayB3aGVuIGNpcmN1aXQgaXMgb3BlbicsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBmYWlsaW5nRm4gPSBqZXN0LmZuKCkubW9ja1JlamVjdGVkVmFsdWUobmV3IEVycm9yKCdmYWlsJykpO1xuICAgIGNvbnN0IGZhbGxiYWNrRm4gPSBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUoJ2ZhbGxiYWNrLXJlc3VsdCcpO1xuICAgIFxuICAgIC8vIE9wZW4gdGhlIGNpcmN1aXRcbiAgICBhd2FpdCBleHBlY3QoYnJlYWtlci5leGVjdXRlKGZhaWxpbmdGbikpLnJlamVjdHMudG9UaHJvdygpO1xuICAgIGF3YWl0IGV4cGVjdChicmVha2VyLmV4ZWN1dGUoZmFpbGluZ0ZuKSkucmVqZWN0cy50b1Rocm93KCk7XG4gICAgZXhwZWN0KGJyZWFrZXIuc3RhdGUpLnRvQmUoJ09QRU4nKTtcbiAgICBcbiAgICAvLyBTaG91bGQgdXNlIGZhbGxiYWNrXG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgYnJlYWtlci5leGVjdXRlKGZhaWxpbmdGbiwgZmFsbGJhY2tGbik7XG4gICAgZXhwZWN0KHJlc3VsdCkudG9CZSgnZmFsbGJhY2stcmVzdWx0Jyk7XG4gICAgZXhwZWN0KGZhbGxiYWNrRm4pLnRvSGF2ZUJlZW5DYWxsZWQoKTtcbiAgfSk7XG5cbiAgdGVzdCgnc2hvdWxkIHJldHVybiBjb3JyZWN0IHN0YXRzJywgKCkgPT4ge1xuICAgIGNvbnN0IHN0YXRzID0gYnJlYWtlci5nZXRTdGF0cygpO1xuICAgIFxuICAgIGV4cGVjdChzdGF0cykudG9IYXZlUHJvcGVydHkoJ25hbWUnLCAndGVzdC1icmVha2VyJyk7XG4gICAgZXhwZWN0KHN0YXRzKS50b0hhdmVQcm9wZXJ0eSgnc3RhdGUnLCAnQ0xPU0VEJyk7XG4gICAgZXhwZWN0KHN0YXRzKS50b0hhdmVQcm9wZXJ0eSgnZmFpbHVyZXMnLCAwKTtcbiAgICBleHBlY3Qoc3RhdHMpLnRvSGF2ZVByb3BlcnR5KCdzdWNjZXNzQ291bnQnLCAwKTtcbiAgICBleHBlY3Qoc3RhdHMpLnRvSGF2ZVByb3BlcnR5KCd0b3RhbENhbGxzJywgMCk7XG4gICAgZXhwZWN0KHN0YXRzKS50b0hhdmVQcm9wZXJ0eSgnc3VjY2Vzc1JhdGUnKTtcbiAgfSk7XG5cbiAgdGVzdCgnc2hvdWxkIHJlc2V0IGNpcmN1aXQgY29ycmVjdGx5JywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IGZhaWxpbmdGbiA9IGplc3QuZm4oKS5tb2NrUmVqZWN0ZWRWYWx1ZShuZXcgRXJyb3IoJ2ZhaWwnKSk7XG4gICAgXG4gICAgLy8gT3BlbiB0aGUgY2lyY3VpdFxuICAgIGF3YWl0IGV4cGVjdChicmVha2VyLmV4ZWN1dGUoZmFpbGluZ0ZuKSkucmVqZWN0cy50b1Rocm93KCk7XG4gICAgYXdhaXQgZXhwZWN0KGJyZWFrZXIuZXhlY3V0ZShmYWlsaW5nRm4pKS5yZWplY3RzLnRvVGhyb3coKTtcbiAgICBleHBlY3QoYnJlYWtlci5zdGF0ZSkudG9CZSgnT1BFTicpO1xuICAgIFxuICAgIC8vIFJlc2V0XG4gICAgYnJlYWtlci5yZXNldCgpO1xuICAgIGV4cGVjdChicmVha2VyLnN0YXRlKS50b0JlKCdDTE9TRUQnKTtcbiAgICBleHBlY3QoYnJlYWtlci5mYWlsdXJlcykudG9CZSgwKTtcbiAgfSk7XG59KTtcbiJdLCJtYXBwaW5ncyI6Ijs7QUFJQSxJQUFBQSxlQUFBLEdBQUFDLE9BQUE7QUFKQTtBQUNBO0FBQ0E7O0FBSUFDLFFBQVEsQ0FBQyxnQkFBZ0IsRUFBRSxNQUFNO0VBQy9CLElBQUlDLE9BQU87RUFFWEMsVUFBVSxDQUFDLE1BQU07SUFDZkQsT0FBTyxHQUFHLElBQUlFLDhCQUFjLENBQUMsY0FBYyxFQUFFO01BQzNDQyxPQUFPLEVBQUUsSUFBSTtNQUNiQyxTQUFTLEVBQUUsQ0FBQztNQUNaQyxZQUFZLEVB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