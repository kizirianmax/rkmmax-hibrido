{"version":3,"names":["_costOptimization","require","describe","beforeEach","jest","useFakeTimers","responseCache","clear","afterEach","useRealTimers","test","cache","ResponseCache","messages","role","content","hash1","generateHash","hash2","expect","toBe","toHaveLength","response","text","get","toBeNull","set","toEqual","advanceTimersByTime","msg1","msg2","msg3","not","prompt","compressed","compressPrompt","length","toBeLessThan","deduplicated","deduplicateMessages","estimateTokens"],"sources":["costOptimization.test.js"],"sourcesContent":["/**\n * COST OPTIMIZATION TESTS\n * Testes unitários completos para o módulo de otimização de custos\n */\n\nimport {\n  responseCache,\n  ResponseCache,\n  compressPrompt,\n  deduplicateMessages,\n  estimateTokens,\n} from \"../costOptimization.js\";\n\ndescribe(\"Cost Optimization Utils\", () => {\n  beforeEach(() => {\n    jest.useFakeTimers();\n    responseCache.clear();\n  });\n\n  afterEach(() => {\n    jest.useRealTimers();\n  });\n\n  describe(\"ResponseCache\", () => {\n    test(\"should generate consistent MD5 hash for same messages\", () => {\n      const cache = new ResponseCache();\n      const messages = [{ role: \"user\", content: \"Hello\" }];\n\n      const hash1 = cache.generateHash(messages);\n      const hash2 = cache.generateHash(messages);\n\n      expect(hash1).toBe(hash2);\n      expect(hash1).toHaveLength(32); // MD5 hash length\n    });\n\n    test(\"should cache and retrieve responses correctly\", () => {\n      const cache = new ResponseCache();\n      const messages = [{ role: \"user\", content: \"Test\" }];\n      const response = { text: \"Response\" };\n\n      // Cache miss initially\n      expect(cache.get(messages)).toBeNull();\n\n      // Set cache\n      cache.set(messages, response);\n\n      // Cache hit\n      expect(cache.get(messages)).toEqual(response);\n    });\n\n    test(\"should expire cached items after TTL\", () => {\n      const cache = new ResponseCache(1000, 100); // 100ms TTL\n      const messages = [{ role: \"user\", content: \"Test\" }];\n      const response = { text: \"Response\" };\n\n      cache.set(messages, response);\n\n      // Should exist initially\n      expect(cache.get(messages)).toEqual(response);\n\n      // Wait for TTL to expire\n      jest.advanceTimersByTime(150);\n\n      // Should be expired\n      expect(cache.get(messages)).toBeNull();\n    });\n\n    test(\"should evict oldest item when maxSize is reached\", () => {\n      const cache = new ResponseCache(2); // Max 2 items\n\n      const msg1 = [{ role: \"user\", content: \"First\" }];\n      const msg2 = [{ role: \"user\", content: \"Second\" }];\n      const msg3 = [{ role: \"user\", content: \"Third\" }];\n\n      cache.set(msg1, { text: \"Response 1\" });\n      cache.set(msg2, { text: \"Response 2\" });\n      cache.set(msg3, { text: \"Response 3\" });\n\n      // First should be evicted\n      expect(cache.get(msg1)).toBeNull();\n      expect(cache.get(msg2)).not.toBeNull();\n      expect(cache.get(msg3)).not.toBeNull();\n    });\n  });\n\n  describe(\"Utility Functions\", () => {\n    test(\"should compress prompts by removing extra whitespace\", () => {\n      const prompt = \"  Hello    world  \\n\\n\\n  How are you?  \";\n      const compressed = compressPrompt(prompt);\n\n      expect(compressed).toBe(\"Hello world\\n\\nHow are you?\");\n      expect(compressed.length).toBeLessThan(prompt.length);\n    });\n\n    test(\"should remove consecutive duplicate messages\", () => {\n      const messages = [\n        { role: \"user\", content: \"Hello\" },\n        { role: \"assistant\", content: \"Hi\" },\n        { role: \"user\", content: \"Hello\" },\n        { role: \"user\", content: \"Hello\" },\n        { role: \"user\", content: \"How are you?\" },\n      ];\n\n      const deduplicated = deduplicateMessages(messages);\n\n      expect(deduplicated).toHaveLength(4);\n      expect(deduplicated[2].content).toBe(\"Hello\");\n      expect(deduplicated[3].content).toBe(\"How are you?\");\n    });\n\n    test(\"should estimate tokens correctly\", () => {\n      expect(estimateTokens(\"test\")).toBe(1); // 4 chars = 1 token\n      expect(estimateTokens(\"Hello world\")).toBe(3); // 11 chars = 3 tokens\n      expect(estimateTokens(\"a\")).toBe(1); // Should round up\n      expect(estimateTokens(\"\")).toBe(0);\n    });\n  });\n});\n"],"mappings":"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","ignoreList":[]}