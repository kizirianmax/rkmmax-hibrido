{"version":3,"names":["CircuitBreaker","constructor","name","options","timeout","threshold","resetTimeout","state","failures","nextAttempt","Date","now","successCount","totalCalls","execute","fn","fallback","console","log","Error","result","withTimeout","onSuccess","error","onFailure","message","Promise","resolve","reject","timer","setTimeout","clearTimeout","getStats","successRate","toFixed","reset","exports","breakers"],"sources":["circuit-breaker.js"],"sourcesContent":["/**\n * üõ°Ô∏è CIRCUIT BREAKER - Prote√ß√£o contra timeouts\n * \n * Implementa circuit breaker pattern com:\n * - Timeout de 8s por chamada (margem de 4s para serverless)\n * - Failover autom√°tico para pr√≥ximo engine\n * - Retry com backoff exponencial\n * - Estados: CLOSED, OPEN, HALF_OPEN\n */\n\nclass CircuitBreaker {\n  constructor(name, options = {}) {\n    this.name = name;\n    this.timeout = options.timeout || 8000; // 8s default (margem de 4s para 12s limit)\n    this.threshold = options.threshold || 3; // Abrir ap√≥s 3 falhas\n    this.resetTimeout = options.resetTimeout || 30000; // 30s para tentar novamente\n    \n    this.state = 'CLOSED'; // CLOSED, OPEN, HALF_OPEN\n    this.failures = 0;\n    this.nextAttempt = Date.now();\n    this.successCount = 0;\n    this.totalCalls = 0;\n  }\n\n  async execute(fn, fallback = null) {\n    this.totalCalls++;\n\n    // Se circuit est√° OPEN, verificar se pode tentar novamente\n    if (this.state === 'OPEN') {\n      if (Date.now() < this.nextAttempt) {\n        console.log(`‚ö° Circuit ${this.name} is OPEN - using fallback`);\n        if (fallback) return await fallback();\n        throw new Error(`Circuit breaker ${this.name} is OPEN`);\n      }\n      // Tentar reabrir (HALF_OPEN)\n      this.state = 'HALF_OPEN';\n      console.log(`üîÑ Circuit ${this.name} entering HALF_OPEN state`);\n    }\n\n    try {\n      // Executar com timeout\n      const result = await this.withTimeout(fn);\n      \n      // Sucesso!\n      this.onSuccess();\n      return result;\n    } catch (error) {\n      // Falha\n      this.onFailure();\n      \n      console.error(`‚ùå Circuit ${this.name} failed:`, error.message);\n      \n      // Se tem fallback, usar\n      if (fallback) {\n        console.log(`üîÑ Using fallback for ${this.name}`);\n        return await fallback();\n      }\n      \n      throw error;\n    }\n  }\n\n  async withTimeout(fn) {\n    return new Promise(async (resolve, reject) => {\n      // Timer de timeout\n      const timer = setTimeout(() => {\n        reject(new Error(`Timeout after ${this.timeout}ms`));\n      }, this.timeout);\n\n      try {\n        const result = await fn();\n        clearTimeout(timer);\n        resolve(result);\n      } catch (error) {\n        clearTimeout(timer);\n        reject(error);\n      }\n    });\n  }\n\n  onSuccess() {\n    this.failures = 0;\n    this.successCount++;\n    \n    if (this.state === 'HALF_OPEN') {\n      console.log(`‚úÖ Circuit ${this.name} recovered - closing circuit`);\n      this.state = 'CLOSED';\n    }\n  }\n\n  onFailure() {\n    this.failures++;\n    \n    if (this.failures >= this.threshold) {\n      this.state = 'OPEN';\n      this.nextAttempt = Date.now() + this.resetTimeout;\n      console.log(`üî¥ Circuit ${this.name} OPENED - too many failures (${this.failures}/${this.threshold})`);\n    }\n  }\n\n  getStats() {\n    return {\n      name: this.name,\n      state: this.state,\n      failures: this.failures,\n      successCount: this.successCount,\n      totalCalls: this.totalCalls,\n      successRate: this.totalCalls > 0 ? (this.successCount / this.totalCalls * 100).toFixed(2) + '%' : '0%',\n    };\n  }\n\n  reset() {\n    this.state = 'CLOSED';\n    this.failures = 0;\n    this.nextAttempt = Date.now();\n  }\n}\n\n// Inst√¢ncias compartilhadas de circuit breakers\nconst breakers = {\n  'gemini-pro': new CircuitBreaker('gemini-pro', { timeout: 8000, threshold: 3 }),\n  'gemini-flash': new CircuitBreaker('gemini-flash', { timeout: 6000, threshold: 3 }),\n  'groq-speed': new CircuitBreaker('groq-speed', { timeout: 5000, threshold: 3 }),\n};\n\nexport { CircuitBreaker, breakers };\n"],"mappings":"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","ignoreList":[]}