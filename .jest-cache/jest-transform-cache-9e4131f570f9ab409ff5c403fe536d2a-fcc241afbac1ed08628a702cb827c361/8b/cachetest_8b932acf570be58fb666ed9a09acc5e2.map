{"version":3,"names":["_cache","require","describe","cache","beforeEach","SmartCache","afterEach","clear","test","messages","role","content","value","response","set","retrieved","get","expect","toEqual","hits","toBe","misses","toBeNull","Promise","resolve","setTimeout","i","size","firstEntry","messages1","messages2","getHitRate","stats","getStats","maxSize","hitRate","totalRequests","key1","generateKey","key2","not","shortCache","cleanup"],"sources":["cache.test.js"],"sourcesContent":["/**\n * Tests for Smart Cache functionality\n */\n\nimport { SmartCache } from '../lib/cache.js';\n\ndescribe('SmartCache', () => {\n  let cache;\n\n  beforeEach(() => {\n    cache = new SmartCache(10, 1000); // Max 10 items, 1s TTL\n  });\n\n  afterEach(() => {\n    cache.clear();\n  });\n\n  test('should store and retrieve cached values', () => {\n    const messages = [{ role: 'user', content: 'test message' }];\n    const value = { response: 'cached response' };\n    \n    cache.set(messages, value);\n    const retrieved = cache.get(messages);\n    \n    expect(retrieved).toEqual(value);\n    expect(cache.hits).toBe(1);\n    expect(cache.misses).toBe(0);\n  });\n\n  test('should return null for cache miss', () => {\n    const messages = [{ role: 'user', content: 'not cached' }];\n    const retrieved = cache.get(messages);\n    \n    expect(retrieved).toBeNull();\n    expect(cache.misses).toBe(1);\n  });\n\n  test('should expire old entries', async () => {\n    const messages = [{ role: 'user', content: 'expire test' }];\n    const value = { response: 'will expire' };\n    \n    cache.set(messages, value);\n    \n    // Wait for TTL to expire\n    await new Promise(resolve => setTimeout(resolve, 1100));\n    \n    const retrieved = cache.get(messages);\n    expect(retrieved).toBeNull();\n  });\n\n  test('should evict oldest entry when max size reached', () => {\n    // Fill cache to max\n    for (let i = 0; i < 10; i++) {\n      cache.set([{ role: 'user', content: `message ${i}` }], { response: `response ${i}` });\n    }\n    \n    expect(cache.cache.size).toBe(10);\n    \n    // Add one more - should evict oldest\n    cache.set([{ role: 'user', content: 'message 10' }], { response: 'response 10' });\n    expect(cache.cache.size).toBe(10);\n    \n    // First entry should be evicted\n    const firstEntry = cache.get([{ role: 'user', content: 'message 0' }]);\n    expect(firstEntry).toBeNull();\n  });\n\n  test('should calculate hit rate correctly', () => {\n    const messages1 = [{ role: 'user', content: 'test 1' }];\n    const messages2 = [{ role: 'user', content: 'test 2' }];\n    \n    cache.set(messages1, { response: 'response 1' });\n    \n    // 1 hit\n    cache.get(messages1);\n    // 1 miss\n    cache.get(messages2);\n    \n    expect(cache.getHitRate()).toBe('50.00');\n  });\n\n  test('should provide accurate stats', () => {\n    const messages = [{ role: 'user', content: 'stats test' }];\n    cache.set(messages, { response: 'test' });\n    cache.get(messages); // hit\n    cache.get([{ role: 'user', content: 'not found' }]); // miss\n    \n    const stats = cache.getStats();\n    \n    expect(stats.size).toBe(1);\n    expect(stats.maxSize).toBe(10);\n    expect(stats.hits).toBe(1);\n    expect(stats.misses).toBe(1);\n    expect(stats.hitRate).toBe('50.00');\n    expect(stats.totalRequests).toBe(2);\n  });\n\n  test('should generate consistent keys for same messages', () => {\n    const messages = [{ role: 'user', content: 'consistency test' }];\n    \n    const key1 = cache.generateKey(messages);\n    const key2 = cache.generateKey(messages);\n    \n    expect(key1).toBe(key2);\n  });\n\n  test('should generate different keys for different messages', () => {\n    const messages1 = [{ role: 'user', content: 'message 1' }];\n    const messages2 = [{ role: 'user', content: 'message 2' }];\n    \n    const key1 = cache.generateKey(messages1);\n    const key2 = cache.generateKey(messages2);\n    \n    expect(key1).not.toBe(key2);\n  });\n\n  test('should clear all cache', () => {\n    for (let i = 0; i < 5; i++) {\n      cache.set([{ role: 'user', content: `message ${i}` }], { response: `response ${i}` });\n    }\n    \n    expect(cache.cache.size).toBe(5);\n    \n    cache.clear();\n    \n    expect(cache.cache.size).toBe(0);\n    expect(cache.hits).toBe(0);\n    expect(cache.misses).toBe(0);\n  });\n\n  test('should cleanup expired entries', async () => {\n    const messages1 = [{ role: 'user', content: 'will expire' }];\n    const messages2 = [{ role: 'user', content: 'still valid' }];\n    \n    // Create cache with short TTL for testing\n    const shortCache = new SmartCache(10, 500);\n    \n    shortCache.set(messages1, { response: 'expires soon' });\n    \n    // Wait a bit\n    await new Promise(resolve => setTimeout(resolve, 600));\n    \n    shortCache.set(messages2, { response: 'fresh entry' });\n    \n    // Cleanup\n    shortCache.cleanup();\n    \n    // Expired should be gone\n    expect(shortCache.get(messages1)).toBeNull();\n    // Fresh should still be there\n    expect(shortCache.get(messages2)).not.toBeNull();\n  });\n});\n"],"mappings":";;AAIA,IAAAA,MAAA,GAAAC,OAAA;AAJA;AACA;AACA;;AAIAC,QAAQ,CAAC,YAAY,EAAE,MAAM;EAC3B,IAAIC,KAAK;EAETC,UAAU,CAAC,MAAM;IACfD,KAAK,GAAG,IAAIE,iBAAU,CAAC,EAAE,EAAE,IAAI,CAAC,CAAC,CAAC;EACpC,CAAC,CAAC;EAEFC,SAAS,CAAC,MAAM;IACdH,KAAK,CAACI,KAAK,CAAC,CAAC;EACf,CAAC,CAAC;EAEFC,IAAI,CAAC,yCAAyC,EAAE,MAAM;IACpD,MAAMC,QAAQ,GAAG,CAAC;MAAEC,IAAI,EAAE,MAAM;MAAEC,OAAO,EAAE;IAAe,CAAC,CAAC;IAC5D,MAAMC,KAAK,GAAG;MAAEC,QAAQ,EAAE;IAAkB,CAAC;IAE7CV,KAAK,CAACW,GAAG,CAACL,QAAQ,EAAEG,KAAK,CAAC;IAC1B,MAAMG,SAAS,GAAGZ,KAAK,CAACa,GAAG,CAACP,QAAQ,CAAC;IAErCQ,MAAM,CAACF,SAAS,CAAC,CAACG,OAAO,CAACN,KAAK,CAAC;IAChCK,MAAM,CAACd,KAAK,CAACgB,IAAI,CAAC,CAACC,IAAI,CAAC,CAAC,CAAC;IAC1BH,MAAM,CAACd,KAAK,CAACkB,MAAM,CAAC,CAACD,IAAI,CAAC,CAAC,CAAC;EAC9B,CAAC,CAAC;EAEFZ,IAAI,CAAC,mCAAmC,EAAE,MAAM;IAC9C,MAAMC,QAAQ,GAAG,CAAC;MAAEC,IAAI,EAAE,MAAM;MAAEC,OAAO,EAAE;IAAa,CAAC,CAAC;IAC1D,MAAMI,SAAS,GAAGZ,KAAK,CAACa,GAAG,CAACP,QAAQ,CAAC;IAErCQ,MAAM,CAACF,SAAS,CAAC,CAACO,QAAQ,CAAC,CAAC;IAC5BL,MAAM,CAACd,KAAK,CAACkB,MAAM,CAAC,CAACD,IAAI,CAAC,CAAC,CAAC;EAC9B,CAAC,CAAC;EAEFZ,IAAI,CAAC,2BAA2B,EAAE,YAAY;IAC5C,MAAMC,QAAQ,GAAG,CAAC;MAAEC,IAAI,EAAE,MAAM;MAAEC,OAAO,EAAE;IAAc,CAAC,CAAC;IAC3D,MAAMC,KAAK,GAAG;MAAEC,QAAQ,EAAE;IAAc,CAAC;IAEzCV,KAAK,CAACW,GAAG,CAACL,QAAQ,EAAEG,KAAK,CAAC;;IAE1B;IACA,MAAM,IAAIW,OAAO,CAACC,OAAO,IAAIC,UAAU,CAACD,OAAO,EAAE,IAAI,CAAC,CAAC;IAEvD,MAAMT,SAAS,GAAGZ,KAAK,CAACa,GAAG,CAACP,QAAQ,CAAC;IACrCQ,MAAM,CAACF,SAAS,CAAC,CAACO,QAAQ,CAAC,CAAC;EAC9B,CAAC,CAAC;EAEFd,IAAI,CAAC,iDAAiD,EAAE,MAAM;IAC5D;IACA,KAAK,IAAIkB,CAAC,GAAG,CAAC,EAAEA,CAAC,GAAG,EAAE,EAAEA,CAAC,EAAE,EAAE;MAC3BvB,KAAK,CAACW,GAAG,CAAC,CAAC;QAAEJ,IAAI,EAAE,MAAM;QAAEC,OAAO,EAAE,WAAWe,CAAC;MAAG,CAAC,CAAC,EAAE;QAAEb,QAAQ,EAAE,YAAYa,CAAC;MAAG,CAAC,CAAC;IACvF;IAEAT,MAAM,CAACd,KAAK,CAACA,KAAK,CAACwB,IAAI,CAAC,CAACP,IAAI,CAAC,EAAE,CAAC;;IAEjC;IACAjB,KAAK,CAACW,GAAG,CAAC,CAAC;MAAEJ,IAAI,EAAE,MAAM;MAAEC,OAAO,EAAE;IAAa,CAAC,CAAC,EAAE;MAAEE,QAAQ,EAAE;IAAc,CAAC,CAAC;IACjFI,MAAM,CAACd,KAAK,CAACA,KAAK,CAACwB,IAAI,CAAC,CAACP,IAAI,CAAC,EAAE,CAAC;;IAEjC;IACA,MAAMQ,UAAU,GAAGzB,KAAK,CAACa,GAAG,CAAC,CAAC;MAAEN,IAAI,EAAE,MAAM;MAAEC,OAAO,EAAE;IAAY,CAAC,CAAC,CAAC;IACtEM,MAAM,CAACW,UAAU,CAAC,CAACN,QAAQ,CAAC,CAAC;EAC/B,CAAC,CAAC;EAEFd,IAAI,CAAC,qCAAqC,EAAE,MAAM;IAChD,MAAMqB,SAAS,GAAG,CAAC;MAAEnB,IAAI,EAAE,MAAM;MAAEC,OAAO,EAAE;IAAS,CAAC,CAAC;IACvD,MAAMmB,SAAS,GAAG,CAAC;MAAEpB,IAAI,EAAE,MAAM;MAAEC,OAAO,EAAE;IAAS,CAAC,CAAC;IAEvDR,KAAK,CAACW,GAAG,CAACe,SAAS,EAAE;MAAEhB,QAAQ,EAAE;IAAa,CAAC,CAAC;;IAEhD;IACAV,KAAK,CAACa,GAAG,CAACa,SAAS,CAAC;IACpB;IACA1B,KAAK,CAACa,GAAG,CAACc,SAAS,CAAC;IAEpBb,MAAM,CAACd,KAAK,CAAC4B,UAAU,CAAC,CAAC,CAAC,CAACX,IAAI,CAAC,OAAO,CAAC;EAC1C,CAAC,CAAC;EAEFZ,IAAI,CAAC,+BAA+B,EAAE,MAAM;IAC1C,MAAMC,QAAQ,GAAG,CAAC;MAAEC,IAAI,EAAE,MAAM;MAAEC,OAAO,EAAE;IAAa,CAAC,CAAC;IAC1DR,KAAK,CAACW,GAAG,CAACL,QAAQ,EAAE;MAAEI,QAAQ,EAAE;IAAO,CAAC,CAAC;IACzCV,KAAK,CAACa,GAAG,CAACP,QAAQ,CAAC,CAAC,CAAC;IACrBN,KAAK,CAACa,GAAG,CAAC,CAAC;MAAEN,IAAI,EAAE,MAAM;MAAEC,OAAO,EAAE;IAAY,CAAC,CAAC,CAAC,CAAC,CAAC;;IAErD,MAAMqB,KAAK,GAAG7B,KAAK,CAAC8B,QAAQ,CAAC,CAAC;IAE9BhB,MAAM,CAACe,KAAK,CAACL,IAAI,CAAC,CAACP,IAAI,CAAC,CAAC,CAAC;IAC1BH,MAAM,CAACe,KAAK,CAACE,OAAO,CAAC,CAACd,IAAI,CAAC,EAAE,CAAC;IAC9BH,MAAM,CAACe,KAAK,CAACb,IAAI,CAAC,CAACC,IAAI,CAAC,CAAC,CAAC;IAC1BH,MAAM,CAACe,KAAK,CAACX,MAAM,CAAC,CAACD,IAAI,CAAC,CAAC,CAAC;IAC5BH,MAAM,CAACe,KAAK,CAACG,OAAO,CAAC,CAACf,IAAI,CAAC,OAAO,CAAC;IACnCH,MAAM,CAACe,KAAK,CAACI,aAAa,CAAC,CAAChB,IAAI,CAAC,CAAC,CAAC;EACrC,CAAC,CAAC;EAEFZ,IAAI,CAAC,mDAAmD,EAAE,MAAM;IAC9D,MAAMC,QAAQ,GAAG,CAAC;MAAEC,IAAI,EAAE,MAAM;MAAEC,OAAO,EAAE;IAAmB,CAAC,CAAC;IAEhE,MAAM0B,IAAI,GAAGlC,KAAK,CAACmC,WAAW,CAAC7B,QAAQ,CAAC;IACxC,MAAM8B,IAAI,GAAGpC,KAAK,CAACmC,WAAW,CAAC7B,QAAQ,CAAC;IAExCQ,MAAM,CAACoB,IAAI,CAAC,CAACjB,IAAI,CAACmB,IAAI,CAAC;EACzB,CAAC,CAAC;EAEF/B,IAAI,CAAC,uDAAuD,EAAE,MAAM;IAClE,MAAMqB,SAAS,GAAG,CAAC;MAAEnB,IAAI,EAAE,MAAM;MAAEC,OAAO,EAAE;IAAY,CAAC,CAAC;IAC1D,MAAMmB,SAAS,GAAG,CAAC;MAAEpB,IAAI,EAAE,MAAM;MAAEC,OAAO,EAAE;IAAY,CAAC,CAAC;IAE1D,MAAM0B,IAAI,GAAGlC,KAAK,CAACmC,WAAW,CAACT,SAAS,CAAC;IACzC,MAAMU,IAAI,GAAGpC,KAAK,CAACmC,WAAW,CAACR,SAAS,CAAC;IAEzCb,MAAM,CAACoB,IAAI,CAAC,CAACG,GAAG,CAACpB,IAAI,CAACmB,IAAI,CAAC;EAC7B,CAAC,CAAC;EAEF/B,IAAI,CAAC,wBAAwB,EAAE,MAAM;IACnC,KAAK,IAAIkB,CAAC,GAAG,CAAC,EAAEA,CAAC,GAAG,CAAC,EAAEA,CAAC,EAAE,EAAE;MAC1BvB,KAAK,CAACW,GAAG,CAAC,CAAC;QAAEJ,IAAI,EAAE,MAAM;QAAEC,OAAO,EAAE,WAAWe,CAAC;MAAG,CAAC,CAAC,EAAE;QAAEb,QAAQ,EAAE,YAAYa,CAAC;MAAG,CAAC,CAAC;IACvF;IAEAT,MAAM,CAACd,KAAK,CAACA,KAAK,CAACwB,IAAI,CAAC,CAACP,IAAI,CAAC,CAAC,CAAC;IAEhCjB,KAAK,CAACI,KAAK,CAAC,CAAC;IAEbU,MAAM,CAACd,KAAK,CAACA,KAAK,CAACwB,IAAI,CAAC,CAACP,IAAI,CAAC,CAAC,CAAC;IAChCH,MAAM,CAACd,KAAK,CAACgB,IAAI,CAAC,CAACC,IAAI,CAAC,CAAC,CAAC;IAC1BH,MAAM,CAACd,KAAK,CAACkB,MAAM,CAAC,CAACD,IAAI,CAAC,CAAC,CAAC;EAC9B,CAAC,CAAC;EAEFZ,IAAI,CAAC,gCAAgC,EAAE,YAAY;IACjD,MAAMqB,SAAS,GAAG,CAAC;MAAEnB,IAAI,EAAE,MAAM;MAAEC,OAAO,EAAE;IAAc,CAAC,CAAC;IAC5D,MAAMmB,SAAS,GAAG,CAAC;MAAEpB,IAAI,EAAE,MAAM;MAAEC,OAAO,EAAE;IAAc,CAAC,CAAC;;IAE5D;IACA,MAAM8B,UAAU,GAAG,IAAIpC,iBAAU,CAAC,EAAE,EAAE,GAAG,CAAC;IAE1CoC,UAAU,CAAC3B,GAAG,CAACe,SAAS,EAAE;MAAEhB,QAAQ,EAAE;IAAe,CAAC,CAAC;;IAEvD;IACA,MAAM,IAAIU,OAAO,CAACC,OAAO,IAAIC,UAAU,CAACD,OAAO,EAAE,GAAG,CAAC,CAAC;IAEtDiB,UAAU,CAAC3B,GAAG,CAACgB,SAAS,EAAE;MAAEjB,QAAQ,EAAE;IAAc,CAAC,CAAC;;IAEtD;IACA4B,UAAU,CAACC,OAAO,CAAC,CAAC;;IAEpB;IACAzB,MAAM,CAACwB,UAAU,CAACzB,GAAG,CAACa,SAAS,CAAC,CAAC,CAACP,QAAQ,CAAC,CAAC;IAC5C;IACAL,MAAM,CAACwB,UAAU,CAACzB,GAAG,CAACc,SAAS,CAAC,CAAC,CAACU,GAAG,CAAClB,QAAQ,CAAC,CAAC;EAClD,CAAC,CAAC;AACJ,CAAC,CAAC","ignoreList":[]}